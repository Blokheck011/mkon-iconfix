$(window).on("gesturechange",function(){MKON.LAYOUT.resize()}),$(window).resize(function(){MKON.LAYOUT.resize()});var isMobile=!1;/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)&&(isMobile=!0),$(document).ready(function(){$("body").fadeIn("slow"),MKON.init(),alertify.set({buttonReverse:!0}),$("#openList").fastClick(function(){return MKON.LAYOUT.locked&&MKON.LAYOUT.unlock(),MKON.LAYOUT.closeMenu(),MKON.LAYOUT.openList(),!1}),$("#closeButton").fastClick(function(){return MKON.LAYOUT.closeList(),!1}),$("#exportModules").fastClick(function(){return MKON.LAYOUT.serialize(),MKON.LAYOUT.openOverlay(),alertify.set({labels:{ok:"IMPORT",cancel:"CANCEL"}}),alertify.prompt('<i class="fa fa-long-arrow-down"></i><i class="fa fa-long-arrow-up"></i> &nbsp; IMPORT / EXPORT',function(e,t){e?(MKON.LAYOUT.closeOverlay(),""!=t&&"undefined"!=typeof t&&MKON.LAYOUT.generate(JSON.parse(t))):MKON.LAYOUT.closeOverlay()},JSON.stringify(MKON.LAYOUT.currentLayout)),alertify.set({labels:{ok:"OK",cancel:"CANCEL"}}),!1}),$("#clearModules").fastClick(function(){return MKON.LAYOUT.initGridster(),MKON.CONTENT.activeModules.length>0?(MKON.LAYOUT.openOverlay(),alertify.confirm('<i class="fa-times-circle fa"></i> &nbsp; Clear ALL modules?',function(e){e&&(MKON.LAYOUT.clear(),MKON.LAYOUT.save()),MKON.LAYOUT.closeOverlay()})):alertify.alert("No modules!"),!1}),$("#mobileMenu").fastClick(function(){MKON.LAYOUT.toggleMenu()}),$("#lockUnlock").fastClick(function(){return MKON.LAYOUT.locked?MKON.LAYOUT.unlock():MKON.LAYOUT.lock(),!1}),$("#moduleContainer .addButton").fastClick(function(e){e.preventDefault();var t=$(e.target).parent(),o=t.data("link"),i={u:o};return MKON.allowSave=!0,MKON.CONTENT.getModule(o,i),!1}),$("#filterButton").on("change",function(){var e=$("#moduleContainer"),t=this.value;switch(e.removeClass(),t){case"all":break;case"buttons":e.addClass("show-button");break;case"screens":e.addClass("show-screen");break;case"resources":e.addClass("show-resource");break;case"dials":e.addClass("show-dial");break;case"scales":e.addClass("show-scale");break;case"utility":e.addClass("show-utility")}}),$("#gridster").on("fastClick",".remove",function(e){var t=$(e.target).closest("li");return MKON.CONTENT.removeModule(t),MKON.LAYOUT.save(),!1}),$("#gridster").on("touchstart mousedown",".command-hold",function(){var e=$(this),t=e.attr("data-com")||!1;t&&MKON.COMMS.repeatCommand(!0,t)}),$("#gridster").on("touchend mouseup",".command-hold",function(){MKON.COMMS.repeatCommand(!1)}),$("#gridster").on("fastClick",".command",function(){var e=$(this),t=$(this).find("a.button")||!1,o=e.attr("data-com")||!1;o&&MKON.COMMS.command(o),t&&(!t.hasClass("no-toggle")||!t.hasClass("action")&&t.hasClass("abort"))&&t.toggleClass("gray")})}),Storage.prototype.setObj=function(e,t){var o=t||"Null";return this.setItem(e,JSON.stringify(o))},Storage.prototype.getObj=function(e){return JSON.parse(this.getItem(e))};var MKON=new Object;MKON={debug:!1,controls:!0,rate:50,localStorageSupport:!1,cacheString:"MKON",datalink:"ws://"+window.location.host+"/datalink",defaults:{"+":["v.name","p.paused","a.version"],rate:this.rate},versionCheck:!1,requiredVersion:"1.4.21.0",allowSave:!0,init:function(){this.COMMS.init(this.datalink,this.defaults),this.LAYOUT.init()},module:function(e,t,o,i,a){this.name=e,this.type=t,this.id=o,this.req=i||[""],this.handleData=a,this.url="",this.col="100",this.row="100"},COMMS:{ws:"",active:!1,paused:!1,received:!1,overflowList:[],overflowActive:!1,overflowAttempts:0,maxOverflowAttempts:100,repeater:!1,repeaterCommand:"",init:function(e,t){if("WebSocket"in window)try{ws=$.gracefulWebSocket(e),MKON.debug&&console.log("Websockets supported!"),ws.onopen=function(){MKON.debug&&console.log("Connection established!"),ws.send(JSON.stringify(t))},ws.onmessage=function(e){if(MKON.debug&&console.log("Received Data"+e.data),MKON.CONTENT.filterData(e.data),!MKON.versionCheck&&MKON.COMMS.active){var t=MKON.CONTENT.getVariable("a.version");"undefined"!=typeof t&&(MKON.debug&&console.log("Telemachus version: "+MKON.CONTENT.getVariable("a.version")),t==MKON.requiredVersion?(MKON.debug&&console.log("Version is ok."),MKON.COMMS.unsubscribe("a.version")):(alertify.error("Version mismatch"),MKON.COMMS.unsubscribe("a.version")),MKON.versionCheck=!0)}MKON.COMMS.active=!0},ws.onerror=function(e){console.log("Error: "+e.data),MKON.COMMS.active=!1},ws.onclose=function(){MKON.debug&&console.log("Connection closed."),MKON.COMMS.active=!1}}catch(o){return console.log(o),!1}else console.log("Websockets not supported")},get:function(e){this.active&&(MKON.debug&&console.log("Getting: "+e),ws.send(JSON.stringify({run:[e]})))},rate:function(e){this.active?(MKON.debug&&console.log("Changing rate to: "+e),ws.send(JSON.stringify({rate:e})),MKON.currentRate=e):this.overflow(e,"rate")},subscribe:function(e){this.active?(MKON.debug&&console.log("Subscribing: "+e),ws.send(JSON.stringify({"+":e}))):this.overflow(e,"+")},unsubscribe:function(e){this.active?(MKON.debug&&console.log("Unsubscribing: "+e),ws.send(JSON.stringify({"-":e}))):this.overflow(e,"-")},repeatCommand:function(e,t){function o(){MKON.debug&&console.log("Sending repeater command"),MKON.COMMS.repeater?(MKON.COMMS.command(MKON.COMMS.repeaterCommand),setTimeout(o,100)):MKON.debug&&console.log("Ending repeater")}this.repeater=e,this.repeaterCommand=t||"",this.repeater&&(MKON.debug&&console.log("Starting command repeater"),o(t))},command:function(e){MKON.controls&&(MKON.LAYOUT.locked&&this.active?(this.active=!1,ws.send(JSON.stringify({run:[e]}))):MKON.LAYOUT.locked&&!this.active)},overflow:function(e,t){function o(){MKON.COMMS.active?(MKON.COMMS.clearOverflow(),MKON.COMMS.overflowActive=!1,MKON.COMMS.overflowAttempts=0):MKON.COMMS.overflowAttempts<MKON.COMMS.maxOverflowAttempts?(MKON.COMMS.overflowAttempts++,setTimeout(o,MKON.rate)):console.log("Overflow timed out!")}var i=[t,e];this.overflowList.push(i),this.overflowList.length>0&&!this.overflowActive&&(MKON.debug&&console.log("Overflow Active"),this.overflowActive=!0,o())},clearOverflow:function(){MKON.debug&&console.log("Overflow Deactivated. ");for(var e=0;e<this.overflowList.length;e++){var t=this.overflowList[e][0],o=this.overflowList[e][1];"+"==t?this.subscribe(o):"-"==t?this.unsubscribe(o):"run"==t&&MKON.LAYOUT.locked?this.command(o):"rate"==t&&this.rate(o)}this.overflowList=[]}},LAYOUT:{locked:!1,gridster:"",gridMargins:4,gridWidth:112,defaultCol:100,defaultRow:100,startCol:100,startRow:100,currentWidget:"",removeZone:$(document.getElementById("removeZone")),lockUnlockWrapper:$(document.getElementById("lockUnlockWrapper")),lockUnlockBtnIcon:$(document.getElementById("lockUnlockBtnIcon")),overlayWrapper:$(document.getElementById("overlayWrapper")),moduleList:$(document.getElementById("moduleList")),logo:$(document.getElementById("logo")),menu:$(document.getElementById("menu")),header:$($("header")),currentLayout:[],prevLayout:!1,viewportWidth:0,viewportHeight:0,removeZoneLimit:0,init:function(){this.resize(),this.gridster=$("#gridster").gridster().data("gridster"),this.setup(),this.unlock()},resize:function(){var e=$(window).width();MKON.LAYOUT.viewportWidth=e,MKON.LAYOUT.viewportHeight=$(window).height();var t=Math.floor(e/this.gridWidth)-1,o=t*this.gridWidth,i=2*this.gridMargins*t,a=e-(i+o);$("#gridsterWrapper").css("left",Math.abs(a/2)+"px"),MKON.LAYOUT.removeZoneLimit=parseInt(MKON.LAYOUT.viewportHeight-MKON.LAYOUT.removeZone.outerHeight()),this.initGridster()},setup:function(){var e=window.location.hash.substring(1);if(e?(this.prevLayout=JSON.parse(e),this.generate(this.prevLayout)):this.prevLayout=!1,"undefined"!=typeof Storage){MKON.debug&&console.log("LocalStorage supported"),MKON.localStorageSupport=!0;try{this.prevLayout||(this.prevLayout=localStorage.getObj(MKON.cacheString),MKON.debug&&console.log("Cache found. ["+this.prevLayout+"]")),null!=this.prevLayout&&(MKON.LAYOUT.generate(MKON.LAYOUT.prevLayout),MKON.debug&&console.log("Generating layout."))}catch(t){console.log("Error getting cache. ["+t+"]")}}},initGridster:function(){$(".gridster ul").gridster({widget_selector:"li",widget_margins:[this.gridMargins,this.gridMargins],widget_base_dimensions:[this.gridWidth,112],draggable:{start:function(e){MKON.LAYOUT.removeZoneAnimation("show"),MKON.LAYOUT.currentWidget=$(e.target).parent()},drag:function(e,t){t.pointer.top>MKON.LAYOUT.removeZoneLimit?MKON.LAYOUT.removeZone.addClass("hover"):MKON.LAYOUT.removeZone.removeClass("hover")},stop:function(e){if($("#removeZone").hasClass("hover")){var t=MKON.LAYOUT.currentWidget;t.hide(),MKON.CONTENT.removeModule(t)}else{var t=$(e.target).parent();MKON.CONTENT.updateModule(t)}MKON.LAYOUT.removeZone.removeClass("hover"),MKON.LAYOUT.removeZoneAnimation("hide")}},resize:{enabled:!0,stop:function(){MKON.LAYOUT.save()}},min_cols:3,serialize_params:function(e,t){return{p:{c:t.col,r:t.row,x:t.size_x,y:t.size_y},u:$(e).attr("data-link"),m:$(e).attr("data-meta")}}})},remove:function(e){this.gridster.remove_widget(e)},add:function(e){this.gridster.add_widget(e.html,e.x,e.y,e.col,e.row)},save:function(){if(MKON.localStorageSupport&&MKON.allowSave){this.serialize(),MKON.debug&&console.log("Saving...");try{localStorage.setObj(MKON.cacheString,this.currentLayout),MKON.debug&&console.log("Layout save successful.")}catch(e){MKON.debug&&console.log("Error saving. ["+e+"]")}}},clear:function(){this.gridster.remove_all_widgets(),MKON.CONTENT.activeModules=[];for(var e=0;e<MKON.CONTENT.activeVariables.length;e++)MKON.COMMS.unsubscribe([MKON.CONTENT.activeVariables[e][0]]);this.checkLogo(),MKON.CONTENT.activeVariables=[]},serialize:function(){this.currentLayout=this.gridster.serialize();for(var e in this.currentLayout)if(this.currentLayout.hasOwnProperty(e)){this.currentLayout[e].u,this.currentLayout[e].c,this.currentLayout[e].r}},generate:function(e){function t(){MKON.allowSave=!0,MKON.LAYOUT.save(),MKON.LAYOUT.unlock(),MKON.debug&&console.log("Cache modules successfully retrieved.")}this.clear(),MKON.allowSave=!1;var o=[];for(var i in e)if(e.hasOwnProperty(i)){var a=e[i].p,n=e[i].u,r=a.c,s=a.r,l=a.x,c=a.y,u=e[i].m,d={u:n,c:r,r:s,m:u,w:l,h:c},h=MKON.CONTENT.getModule(n,d);o.push(h)}$.when.all(o).done(t)},checkLogo:function(){var e=MKON.CONTENT.activeModules.length;1>e||!this.locked?"none"==this.logo.css("display")&&this.logoAnimation("show"):"block"==this.logo.css("display")&&this.logoAnimation("hide")},lockAnimation:function(e){var t=this.lockUnlockWrapper,o=(this.lockUnlockIcon,this.lockUnlockBtnIcon);"lock"==e?(t.addClass("locked"),o.removeClass("fa-unlock").addClass("fa-lock")):"unlock"==e&&(t.removeClass("locked"),o.addClass("fa-unlock").removeClass("fa-lock")),t.addClass("fadeIn").removeClass("fadeOut"),t.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t.removeClass("fadeIn").addClass("fadeOut")})},lock:function(){this.lockAnimation("lock"),this.locked=!0,this.checkLogo(),this.lockAnimation("hide"),$("header").addClass("locked").css("marginTop","-60px"),$("#menu").removeClass("expand"),setTimeout(function(){$("header").css("marginTop","0px")},300),$("#gridsterWrapper").addClass("locked"),this.gridster.disable()},unlock:function(){this.lockAnimation("unlock"),this.locked=!1,this.checkLogo(),$("header").removeClass("locked"),$("#gridsterWrapper").removeClass("locked"),this.gridster.enable()},headerAnimation:function(){this.locked&&this.header.addClass("locked").css("marginTop","-60px")},launchAnimation:function(e,t,o){var o=o||!1;e.addClass(t),e.show(),e.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){e.removeClass(t),o&&e.hide()})},listAnimation:function(e){"open"==e?(this.header.css("marginTop","-60px"),this.launchAnimation(this.moduleList,"animated-med bounceInUp",!1)):"close"==e&&(this.header.css("marginTop","0px"),this.launchAnimation(this.moduleList,"animated bounceOutDown",!0))},logoAnimation:function(e){"show"==e?this.launchAnimation(this.logo,"fadeInUp",!1):"hide"==e&&this.launchAnimation(this.logo,"fadeOutDown",!0)},removeZoneAnimation:function(e){"show"==e?this.launchAnimation(this.removeZone,"fadeInUp",!1):"hide"==e&&this.launchAnimation(this.removeZone,"fadeOutDown",!0)},closeList:function(){this.listAnimation("close"),this.closeOverlay()},openList:function(){this.listAnimation("open"),this.openOverlay()},openOverlay:function(){this.overlayWrapper.fadeIn("fast")},closeOverlay:function(){this.overlayWrapper.fadeOut("fast")},closeMenu:function(){this.menu.hasClass("expand")&&this.menu.removeClass("expand")},toggleMenu:function(){this.menu.toggleClass("expand")}},CONTENT:{freezeData:!1,activeModules:[],activeVariables:[],rawData:[],newData:[],filterData:function(e){this.newData=$.parseJSON(e),this.rawData=this.newData,MKON.COMMS.paused=1==this.rawData["p.paused"]?!0:!1,MKON.CONTENT.handleData()},handleData:function(){if(MKON.COMMS.active&&this.activeModules.length>0)for(var e in this.activeModules)this.activeModules.hasOwnProperty(e)&&this.activeModules[e].handleData()},addHook:function(e,t,o){if(!isMobile){Mousetrap.bind(t,o);var i=$("#"+e);i.on("remove",function(){Mousetrap.unbind(t)})}},removeHook:function(){},getVariable:function(e){return this.rawData[e]},addVariable:function(e){for(var t=-1,o=0;o<this.activeVariables.length;o++)if(this.activeVariables[o][0]==e){t=o;break}if(-1!=t){MKON.debug&&console.log("Variable "+e+" already tracked");var i=parseFloat(this.activeVariables[t][1]);i++,this.activeVariables[t][1]=i}else if(MKON.debug&&console.log(e+" not yet tracked"),this.activeVariables.push([e[0],1]),MKON.COMMS.subscribe(e),!isMobile){var a=this.activeVariables.length,n=(MKON.currentRate,Math.round(a/10)-1);n=0>n?0:n,n=n>MKON.rate.length?MKON.rate.length:n,MKON.currentRate!=MKON.rate[n]&&MKON.COMMS.rate(MKON.rate[n])}},removeVariable:function(e){for(var t=0;t<this.activeVariables.length;t++)if(this.activeVariables[t][0]==e){var o=parseFloat(this.activeVariables[t][1]);1==o?(MKON.debug&&console.log(e+" last tracked variable"),this.activeVariables.splice(t,1),MKON.COMMS.unsubscribe(e)):(o--,MKON.debug&&console.log(o+" more to go! ["+e+"]"),this.activeVariables[t][1]=o);break}},addModule:function(e,t){if(""!=e){this.activeModules.push(e);for(var o=0;o<e.req.length;o++)""!=e.req[o]&&this.addVariable([e.req[o]])}MKON.LAYOUT.add(t),MKON.LAYOUT.save()},removeModule:function(e){var t=e.attr("id");for(var o in this.activeModules)if(this.activeModules.hasOwnProperty(o)&&this.activeModules[o].id==t){mod=this.activeModules[o];for(var i=0;i<mod.req.length;i++)this.removeVariable([mod.req[i]]);this.activeModules.splice(o,1);break}var a=$(e).index();MKON.LAYOUT.remove($("#gridster li").eq(a)),MKON.LAYOUT.save()},updateModule:function(e){for(var t=e.attr("data-col"),o=e.attr("data-row"),i=e.attr("id"),a=0;a<this.activeModules.length;a++)if(this.activeModules[a].id==i){this.activeModules[a].col=t,this.activeModules[a].row=o;break}MKON.LAYOUT.save()},getModule:function(e,t){return $.ajax({type:"GET",url:e,dataType:"script",success:function(){try{return init(t),"test"}catch(e){console.log("Error Initializing Module ["+e+"]")}},error:function(e,t,o){return console.log(o)},async:!0,cache:!0})}},FNC:{zeroPad:function(e,t){var o=t-e.toString().length+1;return Array(+(o>0&&o)).join("0")+e},toFixed:function(e,t){var t=t||0,o=0>e,i=Math.pow(10,t),e=Math.round(e*i),a=String((o?Math.ceil:Math.floor)(e/i)),n=String((o?-e:e)%i),r=new Array(Math.max(t-n.length,0)+1).join("0");return t?a+"."+r+n:a},randomString:function(e,t){t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var o="",i=0;e>i;i++){var a=Math.floor(Math.random()*t.length);o+=t.substring(a,a+1)}return o},formatters:{velocity:function(e){return f=this.formatScale(e,1e3,["Too Large","m/s","Km/s","Mm/s","Gm/s","Tm/s"]),this.fix(f.value)+" "+f.unit},distance:function(e){return f=this.formatScale(e,1e3,["Too Large","m","Km","Mm","Gm","Tm"]),this.fix(f.value)+" "+f.unit},formatScale:function(e,t,o){var i=1,a=0>e;for(e=Math.abs(e);e>t;)e/=t,i+=1;return i>=o.length&&(i=0),a&&(e=-1*e),{value:e,unit:o[i]}},unitless:function(e){return FNC.formatters.fix(e)},time:function(e){f=[86400,3600,60,60],u=["d","h","m","s"],vprime=[0,0,0,0],e=Math.floor(e);for(var t=0;t<f.length;t++)vprime[t]=Math.floor(e/f[t]),e%=f[t];vprime[f.length-1]=e;for(var t=1;t<f.length;t++)vprime[t]<10&&(vprime[t]="0"+vprime[t]);for(var o="",t=0;t<f.length;t++)o=o+vprime[t]+u[t]+" ";return""==o&&(o=0+u[u.length-1]),o},date:function(e){return year=(e/31536e3|0)+1,e%=31536e3,day=(e/86400|0)+1,e%=86400,"Year "+year+", day "+day+" at "+this.hourMinSec(e)},hourMinSec:function(e){return hour=e/3600|0,e%=3600,min=e/60|0,10>min&&(min="0"+min),sec=(e%60).toFixed(),10>sec&&(sec="0"+sec),hour=MKON.FNC.zeroPad(hour,2),""+hour+":"+min+":"+sec},deg:function(e){return FNC.formatters.fix(e)+"°"},fix:function(e){return void 0===e?0:e.toPrecision(6).replace(/((\.\d*?[1-9])|\.)0+($|e)/,"$2$3")},pad:function(e){return("                              "+e).slice(-30)},sigFigs:function(e,t){if(0!=e){var o=!1;0>e&&(o=!0,e=Math.abs(e));var i=Math.pow(10,t-Math.floor(Math.log(e)/Math.LN10)-1);return o&&(e=-1*e),Math.round(e*i)/i}return 0}}}};