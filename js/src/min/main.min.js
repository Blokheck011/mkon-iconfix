function initLocalStorage(){Storage.prototype.setObj=function(e,t){var o=t||"Null";return this.setItem(e,JSON.stringify(o))},Storage.prototype.getObj=function(e){return JSON.parse(this.getItem(e))}}function setupLayout(){var e,t=window.location.hash.substring(1);if(t&&(e=JSON.parse(t),generateLayout(e)),"undefined"!=typeof Storage){console.log("localStorage supported"),localStorageSupport=!0,initLocalStorage(),e||(e=localStorage.getObj("cache"));try{e.length>0&&generateLayout(e)}catch(o){}}else localStorageSupport=!1}var localStorageSupport=!1,isMobile=!1;/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)&&(isMobile=!0,document.write('<script src="http://jsconsole.com/remote.js?A347700A-FD65-4F75-88B1-9E5E2AD4E7EB"></script>'));var Module=function(e,t,o,i,a){this.name=e,this.type=t,this.id=o,this.req=i||[""],this.handleData=a,this.url="",this.col="100",this.row="100"},COMMS={ws:"",datalink:"ws://"+window.location.host+"/datalink",rate:100,init:function(){"WebSocket"in window?(ws=$.gracefulWebSocket(this.datalink),console.log("Websockets supported!"),rate=this.rate,ws.onopen=function(){console.log("Connection established!");var e={"+":["v.name"],rate:rate};ws.send(JSON.stringify(e))},ws.onmessage=function(e){console.log("Received: "+e.data),CONTENT.rawData=$.parseJSON(e.data),CONTENT.handleData()},ws.onerror=function(e){console.log("Error: "+e.data)},ws.onclose=function(){console.log("Connection closed.")}):alert("Websockets not supported")},subscribe:function(e){console.log("subscribing:"+e),ws.send(JSON.stringify({"+":e}))},unsubscribe:function(e){console.log("unsubscribing:"+e),ws.send(JSON.stringify({"-":e}))},command:function(e){LAYOUT.locked&&(console.log("sending command: "+e),ws.send(JSON.stringify({run:[e]})))}},LAYOUT={locked:!1,gridster:"",gridMargins:4,gridWidth:112,defaultCol:100,defaultRow:100,startCol:100,startRow:100,lockUnlockWrapper:$(document.getElementById("lockUnlockWrapper")),lockUnlockBtnIcon:$(document.getElementById("lockUnlockBtnIcon")),overlayWrapper:$(document.getElementById("overlayWrapper")),moduleList:$(document.getElementById("moduleList")),logo:$(document.getElementById("logo")),menu:$(document.getElementById("menu")),header:$($("header")),current:[],init:function(){this.resize(),this.gridster=$("#gridster").gridster().data("gridster"),this.unlock()},resize:function(){var e=$(window).width(),t=Math.floor(e/this.gridWidth)-1,o=t*this.gridWidth,i=2*this.gridMargins*t,a=e-(i+o);$("#gridsterWrapper").css("left",Math.abs(a/2)+"px"),this.initGridster()},initGridster:function(){$(".gridster ul").gridster({widget_selector:"li",widget_margins:[this.gridMargins,this.gridMargins],widget_base_dimensions:[this.gridWidth,112],draggable:{start:function(){},stop:function(e){var t=$(e.target).parent(),o=t.attr("id"),i=t.attr("data-col"),a=t.attr("data-row");CONTENT.updateModule(o,i,a),setTimeout(function(){LAYOUT.save()},100)}},resize:{enabled:!0},min_cols:3,serialize_params:function(e,t){return{c:t.col,r:t.row,u:$(e).attr("data-link")}}})},remove:function(e){this.gridster.remove_widget(e)},add:function(e){this.gridster.add_widget(e.html,e.x,e.y,e.col,e.row)},save:function(){if(console.log("running save"),localStorageSupport){LAYOUT.serialize();try{localStorage.setObj("cache",LAYOUT.current)}catch(e){}}},clear:function(){LAYOUT.gridster.remove_all_widgets(),CONTENT.activeModules=[];for(var e=0;e<CONTENT.activeVariables.length;e++)COMMS.unsubscribe(CONTENT.activeVariables[e][0]),console.log(CONTENT.activeVariables[e][0]);this.checkLogo(),CONTENT.activeVariables=[]},serialize:function(){this.current=this.gridster.serialize();for(var e in this.current)if(this.current.hasOwnProperty(e)){this.current[e].u,this.current[e].c,this.current[e].r}},generate:function(e){LAYOUT.clear();for(var t in e)if(e.hasOwnProperty(t)){var o=e[t].u,i=e[t].c,a=e[t].r;CONTENT.retrieveModule(o,i,a)}LAYOUT.unlock()},checkLogo:function(){var e=CONTENT.activeModules.length;1>e||!LAYOUT.locked?"none"==this.logo.css("display")&&this.logoAnimation("show"):"block"==this.logo.css("display")&&this.logoAnimation("hide")},lockAnimation:function(e){var t=this.lockUnlockWrapper,o=(this.lockUnlockIcon,this.lockUnlockBtnIcon);"lock"==e?(t.addClass("locked"),o.removeClass("fa-unlock").addClass("fa-lock")):"unlock"==e&&(t.removeClass("locked"),o.addClass("fa-unlock").removeClass("fa-lock")),t.addClass("fadeIn").removeClass("fadeOut"),t.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t.removeClass("fadeIn").addClass("fadeOut")})},lock:function(){this.lockAnimation("lock"),this.locked=!0,this.checkLogo(),this.lockAnimation("hide"),$("header").addClass("locked").css("marginTop","-60px"),$("#menu").removeClass("expand"),setTimeout(function(){$("header").css("marginTop","0px")},300),$("#gridsterWrapper").addClass("locked"),this.gridster.disable()},unlock:function(){this.lockAnimation("unlock"),this.locked=!1,this.checkLogo(),$("header").removeClass("locked"),$("#gridsterWrapper").removeClass("locked"),this.gridster.enable()},headerAnimation:function(){this.locked&&this.header.addClass("locked").css("marginTop","-60px")},launchAnimation:function(e,t,o){var o=o||!1;e.addClass(t),e.show(),e.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){e.removeClass(t),o&&e.hide()})},listAnimation:function(e){"open"==e?this.launchAnimation(this.moduleList,"animated-med bounceInUp",!1):"close"==e&&this.launchAnimation(this.moduleList,"animated bounceOutDown",!0)},logoAnimation:function(e){"show"==e?this.launchAnimation(this.logo,"fadeInUp",!1):"hide"==e&&this.launchAnimation(this.logo,"fadeOutDown",!0)},closeList:function(){this.listAnimation("close"),this.closeOverlay()},openList:function(){this.listAnimation("open"),this.openOverlay()},openOverlay:function(){this.overlayWrapper.fadeIn("fast")},closeOverlay:function(){this.overlayWrapper.fadeOut("fast")},closeMenu:function(){this.menu.hasClass("expand")&&this.menu.removeClass("expand")},toggleMenu:function(){this.menu.toggleClass("expand")}},CONTENT={activeModules:[],activeVariables:[],rawData:[],handleData:function(){for(var e in this.activeModules)this.activeModules.hasOwnProperty(e)&&this.activeModules[e].handleData()},addHook:function(e,t,o){if(!isMobile){Mousetrap.bind(t,o);var i=$("#"+e);i.on("remove",function(){Mousetrap.unbind(t)})}},removeHook:function(){},getVariable:function(e){return this.rawData[e]},addVariable:function(e){for(var t=-1,o=0;o<this.activeVariables.length;o++)if(this.activeVariables[o][0]==e){t=o;break}if(-1!=t){console.log("already tracked");var i=parseFloat(this.activeVariables[t][1]);i++,this.activeVariables[t][1]=i}else console.log("not yet tracked"),this.activeVariables.push([e[0],1]),COMMS.subscribe(e)},removeVariable:function(e){for(var t=0;t<this.activeVariables.length;t++)if(this.activeVariables[t][0]==e){var o=parseFloat(this.activeVariables[t][1]);1==o?(console.log("its the last one"),this.activeVariables.splice(t,1),COMMS.unsubscribe(e)):(o--,console.log(o+"more to go!"),this.activeVariables[t][1]=o);break}},addModule:function(e,t){this.activeModules.push(e);for(var o=0;o<e.req.length;o++)""!=e.req[o]&&this.addVariable([e.req[o]]);LAYOUT.add(t)},removeModule:function(e){var t=e.attr("id");for(var o in this.activeModules)if(this.activeModules.hasOwnProperty(o)&&this.activeModules[o].id==t){mod=this.activeModules[o];for(var i=0;i<mod.req.length;i++)this.removeVariable([mod.req[i]]);this.activeModules.splice(o,1);break}var a=$(e).index();LAYOUT.remove($("#gridster li").eq(a))},updateModule:function(e,t,o){for(var e=e,i=0;i<this.activeModules.length;i++)if(this.activeModules[i].id==e){this.activeModules[i].col=t,this.activeModules[i].row=o;break}},retrieveModule:function(e,t,o){var i=e,a=t||LAYOUT.defaultCol,n=o||LAYOUT.defaultRow;$.ajax({type:"GET",url:i,dataType:"script",success:function(){try{init(a,n,i),LAYOUT.save()}catch(e){}},error:function(e,t,o){console.log(o)},cache:!0})}},FNC={zeroPad:function(e,t){var o=t-e.toString().length+1;return Array(+(o>0&&o)).join("0")+e},toFixed:function(e,t){var t=t||0,o=0>e,i=Math.pow(10,t),e=Math.round(e*i),a=String((o?Math.ceil:Math.floor)(e/i)),n=String((o?-e:e)%i),r=new Array(Math.max(t-n.length,0)+1).join("0");return t?a+"."+r+n:a},randomString:function(e,t){t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var o="",i=0;e>i;i++){var a=Math.floor(Math.random()*t.length);o+=t.substring(a,a+1)}return o},formatters:{velocity:function(e){return f=FNC.formatters.formatScale(e,1e3,["Too Large","m/s","Km/s","Mm/s","Gm/s","Tm/s"]),FNC.formatters.fix(f.value)+" "+f.unit},distance:function(e){return f=FNC.formatters.formatScale(e,1e3,["Too Large","m","Km","Mm","Gm","Tm"]),FNC.formatters.fix(f.value)+" "+f.unit},formatScale:function(e,t,o){var i=1,a=0>e;for(e=Math.abs(e);e>t;)e/=t,i+=1;return i>=o.length&&(i=0),a&&(e=-1*e),{value:e,unit:o[i]}},unitless:function(e){return FNC.formatters.fix(e)},time:function(e){f=[86400,3600,60,60],u=["d","h","m","s"],vprime=[0,0,0,0],e=Math.floor(e);for(var t=0;t<f.length;t++)vprime[t]=Math.floor(e/f[t]),e%=f[t];vprime[f.length-1]=e;for(var t=1;t<f.length;t++)vprime[t]<10&&(vprime[t]="0"+vprime[t]);for(var o="",t=0;t<f.length;t++)o=o+vprime[t]+u[t]+" ";return""==o&&(o=0+u[u.length-1]),o},date:function(e){return year=(e/31536e3|0)+1,e%=31536e3,day=(e/86400|0)+1,e%=86400,"Year "+year+", day "+day+" at "+FNC.formatters.hourMinSec(e)},hourMinSec:function(e){return hour=e/3600|0,e%=3600,min=e/60|0,10>min&&(min="0"+min),sec=(e%60).toFixed(),10>sec&&(sec="0"+sec),hour=FNC.zeroPad(hour,2),""+hour+":"+min+":"+sec},deg:function(e){return FNC.formatters.fix(e)+"°"},fix:function(e){return void 0===e?0:e.toPrecision(6).replace(/((\.\d*?[1-9])|\.)0+($|e)/,"$2$3")},pad:function(e){return("                              "+e).slice(-30)},sigFigs:function(e,t){if(0!=e){var o=!1;0>e&&(o=!0,e=Math.abs(e));var i=Math.pow(10,t-Math.floor(Math.log(e)/Math.LN10)-1);return o&&(e=-1*e),Math.round(e*i)/i}return 0}}};$(window).on("gesturechange",function(){LAYOUT.resize()}),$(window).resize(function(){LAYOUT.resize()}),$(document).ready(function(){COMMS.init(),LAYOUT.init(),alertify.set({buttonReverse:!0}),$(document).on("keypress",function(e){102===e.which&&(localStorage.cache="",LAYOUT.save(),alertify.alert("Cache cleared"))}),$("#closeButton").fastClick(function(){return LAYOUT.closeList(),!1}),$("#settingsButton").fastClick(function(){return alertify.alert("Coming soon..."),!1}),$("#exportModules").fastClick(function(){return LAYOUT.serialize(),LAYOUT.openOverlay(),alertify.set({labels:{ok:"IMPORT",cancel:"CANCEL"}}),alertify.prompt('<i class="fa fa-long-arrow-down"></i><i class="fa fa-long-arrow-up"></i> &nbsp; IMPORT / EXPORT',function(e,t){e?(LAYOUT.closeOverlay(),""!=t&&"undefined"!=typeof t&&LAYOUT.generate(JSON.parse(t))):LAYOUT.closeOverlay()},JSON.stringify(LAYOUT.current)),alertify.set({labels:{ok:"OK",cancel:"CANCEL"}}),!1}),$("#openList").fastClick(function(){return LAYOUT.locked&&LAYOUT.unlock(),LAYOUT.closeMenu(),LAYOUT.openList(),!1}),$("#clearModules").fastClick(function(){return LAYOUT.initGridster(),CONTENT.activeModules.length>0?(LAYOUT.openOverlay(),alertify.confirm('<i class="fa-times-circle fa"></i> &nbsp; Clear ALL modules?',function(e){e&&(LAYOUT.clear(),LAYOUT.save()),LAYOUT.closeOverlay()})):alertify.alert("No modules!"),!1}),$("#mobileMenu").fastClick(function(){LAYOUT.toggleMenu()}),$("#lockUnlock").fastClick(function(){return LAYOUT.locked?LAYOUT.unlock():LAYOUT.lock(),!1}),$("#moduleContainer .addButton").fastClick(function(e){e.preventDefault();{var t=$(e.target).parent(),o=t.data("link");t.data("type")}return CONTENT.retrieveModule(o),!1}),$("#filterButton").on("change",function(){var e=$("#moduleContainer"),t=this.value;switch(e.removeClass(),t){case"all":break;case"buttons":e.addClass("show-button");break;case"screens":e.addClass("show-screen");break;case"resources":e.addClass("show-resource");break;case"dials":e.addClass("show-dial");break;case"scales":e.addClass("show-scale")}}),$("#gridster").on("fastClick",".remove",function(e){var t=$(e.target).closest("li");return CONTENT.removeModule(t),LAYOUT.save(),!1}),$("#gridster").on("fastClick",".button",function(e){var t=$(e.target);if(!t.hasClass("no-toggle")||!t.hasClass("action")&&t.hasClass("abort")){t.toggleClass("gray");var o=t.closest("li").attr("data-com")||!1;o&&COMMS.command(o)}return!1})});